<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="A pure Ruby client for Apache Cassandra">
    <meta name="author" content="DataStax">

    <title>Ruby Driver for Apache Cassandra - Datacenter-aware Round Robin Policy</title>

    <link rel="icon" href="../../../../favicon.ico">
    <link rel="apple-touch-icon" href="../../../../favicon.png">
    <link href="../../../../css/style.css" rel="stylesheet">
    <link href="../../../../css/pygments.css" rel="stylesheet">
    <link href="../../../../css/hotkeys.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body ng-app="docs" data-spy="scroll" data-target=".side-nav">
    <header class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../">Ruby Driver for Apache Cassandra</a>
        </div>
        <div class="collapse navbar-collapse" ng-controller="search">
          <ul class="nav navbar-nav">
            
            <li>
              <a href="../../../">Introduction</a>
            </li>
            
            <li class="active">
              <a href="../../">Features</a>
            </li>
            
            <li>
              <a href="../../../api/">API docs</a>
            </li>
            
          </ul>
          <form class="navbar-form form-search navbar-right dropdown visible-lg-block" ng-class="{open: hasResults}" role="search" ng-submit="submit()">
            <div class="form-group has-feedback">
              <input type="search" class="form-control input-sm mousetrap" placeholder="Search..." ng-model="q" ng-change="search('v2.1.0')" ng-disabled="!searchReady" disabled data-hotkey="{down: moveDown, up: moveUp, esc: reset}" data-search>
            </div>
            <ul class="dropdown-menu" role="menu">
              <li ng-repeat="result in results" ng-class="{'bg-warning': $index == current}"><a ng-href="{{basePath}}{{result.path}}"><span ng-bind-html="summary(result)"></span></a></li>
            </ul>
          </form>
        </div>
      </div>
    </header>

    <div class="container" id="content">
      <div class="row">
        <div class="col-md-9 content">
          <nav class="crumbs">
            <ol class="breadcrumb">
              
              <li>
                <div class="dropdown">
                  <button id="current-version" class="btn btn-default btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    v2.1.0
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="current-version">
                  
                    <li><a href="../../../../features/load_balancing/datacenter_aware/">v2.1.1</a></li>
                  
                    <li class="disabled"><a href="./">v2.1.0</a></li>
                  
                    <li><a href="../../../../v2.0.1/features/load_balancing/datacenter_aware/">v2.0.1</a></li>
                  
                    <li><a href="../../../../v2.0.0/features/load_balancing/datacenter_aware/">v2.0.0</a></li>
                  
                    <li><a href="../../../../v1.2.0/features/load_balancing/datacenter_aware/">v1.2.0</a></li>
                  
                    <li><a href="../../../../v1.1.1/features/load_balancing/datacenter_aware/">v1.1.1</a></li>
                  
                    <li><a href="../../../../v1.1.0/features/load_balancing/datacenter_aware/">v1.1.0</a></li>
                  
                    <li><a href="../../../../v1.0.0/features/load_balancing/datacenter_aware/">v1.0.0</a></li>
                  
                    <li><a href="../../../../v1.0.0-rc.1/features/load_balancing/datacenter_aware/">v1.0.0-rc.1</a></li>
                  
                    <li><a href="../../../../v1.0.0-beta.3/features/load_balancing/datacenter_aware/">v1.0.0-beta.3</a></li>
                  
                    <li><a href="../../../../v1.0.0-beta.2/features/load_balancing/datacenter_aware/">v1.0.0-beta.2</a></li>
                  
                    <li><a href="../../../../v1.0.0-beta.1/features/load_balancing/datacenter_aware/">v1.0.0-beta.1</a></li>
                  
                  </ul>
                </div>
              </li>
              
              
              
              
              <li><a href="../../../">Introduction</a></li>
              
              
              
              
              
              <li><a href="../../">Usage</a></li>
              
              
              
              
              
              <li><a href="../">Load Balancing</a></li>
              
              
              
              
              
              <li class="active">Datacenter-aware Round Robin Policy</li>
              
              
              
            </ol>
          </nav>
          
<div class="feature-section">
<h1 id="datacenter-aware-round-robin-policy">Datacenter-aware Round Robin Policy<a class="anchor" href="#datacenter-aware-round-robin-policy" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h1>
<p>A specialized Round Robin load balancing policy allows for querying remote
datacenters only when all local nodes are down. This policy will round robin
requests across hosts in the local datacenter, falling back to remote
datacenter if necessary. The name of the local datacenter must be supplied by
the user.</p>

<p>All known remote hosts will be tried when local nodes are not available.
However, you can configure the exact number of remote hosts that will be used
by passing that number when constructing a policy instance.</p>

<p>By default, this policy will not attempt to use remote hosts for local
consistencies (<code>:local_one</code> or <code>:local_quorum</code>), however, it is possible to
change that behavior via constructor.</p>
<h2 id="background">Background<a class="anchor" href="#background" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>a running cassandra cluster in 2 datacenters with 2 nodes in each</dd>
<dt>And </dt>
<dd>the following schema:<pre class="highlight"><code><span class="k">CREATE</span> <span class="k">KEYSPACE</span> <span class="n">simplex</span> <span class="k">WITH</span> <span class="n">replication</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'class'</span><span class="p">:</span> <span class="s1">'SimpleStrategy'</span><span class="p">,</span> <span class="s1">'replication_factor'</span><span class="p">:</span> <span class="mi">3</span><span class="p">};</span>
<span class="k">USE</span> <span class="n">simplex</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">songs</span> <span class="p">(</span>
  <span class="n">id</span> <span class="k">uuid</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">title</span> <span class="k">text</span><span class="p">,</span>
  <span class="n">album</span> <span class="k">text</span><span class="p">,</span>
  <span class="n">artist</span> <span class="k">text</span><span class="p">,</span>
  <span class="n">tags</span> <span class="k">set</span><span class="o">&lt;</span><span class="k">text</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">data</span> <span class="k">blob</span>
<span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span>
   <span class="mi">756716f7-2e54-4715-9f00-91dcbea6cf50</span><span class="p">,</span>
   <span class="s1">'La Petite Tonkinoise'</span><span class="p">,</span>
   <span class="s1">'Bye Bye Blackbird'</span><span class="p">,</span>
   <span class="s1">'Joséphine Baker'</span><span class="p">,</span>
   <span class="p">{</span><span class="s1">'jazz'</span><span class="p">,</span> <span class="s1">'2013'</span><span class="p">})</span>
<span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span>
   <span class="mi">f6071e72-48ec-4fcb-bf3e-379c8a696488</span><span class="p">,</span>
   <span class="s1">'Die Mösch'</span><span class="p">,</span>
   <span class="s1">'In Gold'</span><span class="p">,</span>
   <span class="s1">'Willi Ostermann'</span><span class="p">,</span>
   <span class="p">{</span><span class="s1">'kölsch'</span><span class="p">,</span> <span class="s1">'1996'</span><span class="p">,</span> <span class="s1">'birds'</span><span class="p">}</span>
<span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">songs</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span>
   <span class="mi">fbdf82ed-0063-4796-9c7c-a3d4f47b4b25</span><span class="p">,</span>
   <span class="s1">'Memo From Turner'</span><span class="p">,</span>
   <span class="s1">'Performance'</span><span class="p">,</span>
   <span class="s1">'Mick Jager'</span><span class="p">,</span>
   <span class="p">{</span><span class="s1">'soundtrack'</span><span class="p">,</span> <span class="s1">'1991'</span><span class="p">}</span>
<span class="p">);</span>
</code></pre>
</dd>
</dl>
<h2 id="first-seen-datacenter-is-considered-local-when-not-explicitly-given">First seen datacenter is considered local when not explicitly given<a class="anchor" href="#first-seen-datacenter-is-considered-local-when-not-explicitly-given" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">policy</span>     <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span>
<span class="n">hosts</span>      <span class="o">=</span> <span class="p">[</span><span class="s1">'127.0.0.3'</span><span class="p">,</span> <span class="s1">'127.0.0.4'</span><span class="p">]</span>
<span class="n">cluster</span>    <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">hosts: </span><span class="n">hosts</span><span class="p">,</span> <span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>    <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="n">hosts_used</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">).</span><span class="nf">execution_info</span>
  <span class="n">info</span><span class="p">.</span><span class="nf">hosts</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">ip</span>
<span class="k">end</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">uniq</span>

<span class="nb">puts</span> <span class="n">hosts_used</span>
</code></pre>
</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should contain:<pre><code>127.0.0.3
127.0.0.4
</code></pre>
</dd>
</dl>
<h2 id="requests-are-automatically-routed-to-local-datacenter">Requests are automatically routed to local datacenter<a class="anchor" href="#requests-are-automatically-routed-to-local-datacenter" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">datacenter</span> <span class="o">=</span> <span class="s2">"dc2"</span>
<span class="n">policy</span>     <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">datacenter</span><span class="p">)</span>
<span class="n">cluster</span>    <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>    <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="n">hosts_used</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">).</span><span class="nf">execution_info</span>
  <span class="n">info</span><span class="p">.</span><span class="nf">hosts</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">ip</span>
<span class="k">end</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">uniq</span>

<span class="nb">puts</span> <span class="n">hosts_used</span>
</code></pre>
</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should contain:<pre><code>127.0.0.3
127.0.0.4
</code></pre>
</dd>
</dl>
<h2 id="requests-are-routed-to-remote-datacenters-if-local-datacenter-is-down">Requests are routed to remote datacenters if local datacenter is down<a class="anchor" href="#requests-are-routed-to-remote-datacenters-if-local-datacenter-is-down" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">datacenter</span> <span class="o">=</span> <span class="s2">"dc2"</span>
<span class="n">policy</span>     <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">datacenter</span><span class="p">)</span>
<span class="n">cluster</span>    <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">consistency: :one</span><span class="p">,</span> <span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>    <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="n">hosts_used</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">).</span><span class="nf">execution_info</span>
  <span class="n">info</span><span class="p">.</span><span class="nf">hosts</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">ip</span>
<span class="k">end</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">uniq</span>

<span class="nb">puts</span> <span class="n">hosts_used</span>
</code></pre>
</dd>
<dt>And </dt>
<dd>node 3 is stopped</dd>
<dt>And </dt>
<dd>node 4 is stopped</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should contain:<pre><code>127.0.0.1
127.0.0.2
</code></pre>
</dd>
</dl>
<h2 id="requests-are-routed-up-to-a-maximum-number-of-hosts-in-remote-datacenters">Requests are routed up to a maximum number of hosts in remote datacenters<a class="anchor" href="#requests-are-routed-up-to-a-maximum-number-of-hosts-in-remote-datacenters" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">datacenter</span>     <span class="o">=</span> <span class="s2">"dc2"</span>
<span class="n">remotes_to_try</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">policy</span>         <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">datacenter</span><span class="p">,</span> <span class="n">remotes_to_try</span><span class="p">)</span>
<span class="n">cluster</span>        <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">consistency: :one</span><span class="p">,</span> <span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>        <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="n">hosts_used</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">).</span><span class="nf">execution_info</span>
  <span class="n">info</span><span class="p">.</span><span class="nf">hosts</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">ip</span>
<span class="k">end</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">uniq</span>

<span class="nb">puts</span> <span class="s2">"Used </span><span class="si">#{</span><span class="n">hosts_used</span><span class="p">.</span><span class="nf">size</span><span class="si">}</span><span class="s2"> host, with ip </span><span class="si">#{</span><span class="n">hosts_used</span><span class="p">.</span><span class="nf">first</span><span class="si">}</span><span class="s2">"</span>
</code></pre>
</dd>
<dt>And </dt>
<dd>node 3 is stopped</dd>
<dt>And </dt>
<dd>node 4 is stopped</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should match:<pre><code>Used 1 host, with ip 127\.0\.0\.(1|2)
</code></pre>
</dd>
</dl>
<h2 id="requests-with-local-consistencies-are-not-routed-to-remote-datacenters">Requests with local consistencies are not routed to remote datacenters<a class="anchor" href="#requests-with-local-consistencies-are-not-routed-to-remote-datacenters" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">datacenter</span> <span class="o">=</span> <span class="s2">"dc2"</span>
<span class="n">policy</span>     <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">datacenter</span><span class="p">)</span>
<span class="n">cluster</span>    <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">consistency: :one</span><span class="p">,</span> <span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>    <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="k">begin</span>
  <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">,</span> <span class="ss">consistency: :local_one</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"failure"</span>
<span class="k">rescue</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">Errors</span><span class="o">::</span><span class="no">NoHostsAvailable</span>
  <span class="nb">puts</span> <span class="s2">"success"</span>
<span class="k">end</span>
</code></pre>
</dd>
<dt>And </dt>
<dd>node 3 is stopped</dd>
<dt>And </dt>
<dd>node 4 is stopped</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should contain:<pre><code>success
</code></pre>
</dd>
</dl>
<h2 id="routing-requests-with-local-consistencies-to-remote-datacenters">Routing requests with local consistencies to remote datacenters<a class="anchor" href="#routing-requests-with-local-consistencies-to-remote-datacenters" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>
<dl class="steps">
<dt>Given </dt>
<dd>the following example:<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">datacenter</span> <span class="o">=</span> <span class="s2">"dc2"</span>
<span class="n">use_remote</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">policy</span>     <span class="o">=</span> <span class="no">Cassandra</span><span class="o">::</span><span class="no">LoadBalancing</span><span class="o">::</span><span class="no">Policies</span><span class="o">::</span><span class="no">DCAwareRoundRobin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">datacenter</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">use_remote</span><span class="p">)</span>
<span class="n">cluster</span>    <span class="o">=</span> <span class="no">Cassandra</span><span class="p">.</span><span class="nf">cluster</span><span class="p">(</span><span class="ss">consistency: :one</span><span class="p">,</span> <span class="ss">load_balancing_policy: </span><span class="n">policy</span><span class="p">)</span>
<span class="n">session</span>    <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'simplex'</span><span class="p">)</span>

<span class="n">hosts_used</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM songs"</span><span class="p">).</span><span class="nf">execution_info</span>
  <span class="n">info</span><span class="p">.</span><span class="nf">hosts</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">ip</span>
<span class="k">end</span><span class="p">.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">uniq</span>

<span class="nb">puts</span> <span class="n">hosts_used</span>
</code></pre>
</dd>
<dt>And </dt>
<dd>node 3 is stopped</dd>
<dt>And </dt>
<dd>node 4 is stopped</dd>
<dt>When </dt>
<dd>it is executed</dd>
<dt>Then </dt>
<dd>its output should contain:<pre><code>127.0.0.1
127.0.0.2
</code></pre>
</dd>
</dl>
</div>

        </div>
        <div class="col-md-3">
          <div id="navigation" class="panel-group side-nav" data-spy="affix" data-offset-top="60" data-offset-bottom="54" role="tablist" aria-multiselectable="true">
            <div class="panel panel-default">
              <div id="table-of-contents-heading" class="panel-heading" role="tab">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#navigation" href="#table-of-contents" aria-expanded="true" aria-controls="table-of-contents">Contents</a>
                </h4>
              </div>
              <div id="table-of-contents" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="table-of-contents-heading">
                <div class="panel-body">
                  <ol class="nav nav-pills nav-stacked toc">
<li><a href="#background">Background
</a></li>
<li><a href="#first-seen-datacenter-is-considered-local-when-not-explicitly-given">First seen datacenter is considered local when not explicitly given
</a></li>
<li><a href="#requests-are-automatically-routed-to-local-datacenter">Requests are automatically routed to local datacenter
</a></li>
<li><a href="#requests-are-routed-to-remote-datacenters-if-local-datacenter-is-down">Requests are routed to remote datacenters if local datacenter is down
</a></li>
<li><a href="#requests-are-routed-up-to-a-maximum-number-of-hosts-in-remote-datacenters">Requests are routed up to a maximum number of hosts in remote datacenters
</a></li>
<li><a href="#requests-with-local-consistencies-are-not-routed-to-remote-datacenters">Requests with local consistencies are not routed to remote datacenters
</a></li>
<li><a href="#routing-requests-with-local-consistencies-to-remote-datacenters">Routing requests with local consistencies to remote datacenters
</a></li>
</ol>
                </div>
              </div>
            </div>

            
          </div>
        </div>
      </div>
    </div>

    
    <footer class="container text-muted">
      <ul class="list-inline">
      
        
        <li>
          <a href="https://github.com/datastax/ruby-driver/">Code</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="http://datastax.github.io/ruby-driver/">Docs</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://datastax-oss.atlassian.net/browse/RUBY/">Issues</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/ruby-driver-user">Mailing List</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="irc://irc.freenode.net/datastax-drivers">IRC Channel</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://github.com/datastax/ruby-driver/releases">Releases</a>
        </li>
      
      </ul>
    </footer>
    

    <script src="../../../../js/jquery.js"></script>
    <script src="../../../../js/bootstrap.js"></script>
    <script src="../../../../js/angular.js"></script>
    <script src="../../../../js/mousetrap.js"></script>
    <script src="../../../../js/hotkeys.js"></script>
    <script src="../../../../js/ZeroClipboard.js"></script>
    <script src="../../../../js/lunr.js"></script>
    <script src="../../../../js/app.js"></script>
  </body>
</html>
